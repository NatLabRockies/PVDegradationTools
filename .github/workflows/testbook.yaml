name: notebook-testbook-check

on: [pull_request]

jobs:
  # notebook-testbook-check:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       notebook-file: [
  #         "API Call Required - PYSam.ipynb",
  #         # "Removed store.py Required - load_pvgis_distributed.ipynb",
  #         "API Call Required - load_nsrdb_distributed.ipynb",
  #         #"HPC Connection Required - Geospatial_world_map.ipynb",
  #         #"HPC Connection Required - DuraMAT Live Demo.ipynb",
  #         "HPC Connection Required - Scenario - Geographical Features.ipynb",
  #         "HPC Connection Required - Scenario - Geospatial.ipynb",
  #         "HPC Connection Required - Scenario - Non-uniform Mountain Prefferential Downselect.ipynb",
  #         "HPC Connection Required - Scenario - Single Location.ipynb",
  #         "HPC Connection Required - Scenario - Temperature.ipynb",
  #         "HPC Connection Required - Tools - Module Standoff for IEC TS 63126.ipynb",
  #         #"HPC Connection Required - LETID - Outdoor Geospatial Demo.ipynb",
  #         "HPC Connection Required - Geospatial Templates.ipynb",
  #       ]

  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Set up Python
  #     uses: actions/setup-python@v5
  #     with:
  #       python-version: "3.13"
  #   - name: Install notebook environment
  #     run: |
  #       python -m pip install --upgrade pip wheel
  #       pip install --timeout=300 \
  #           -r tutorials_and_tools/requirements.txt
  #       pip install --timeout=300 -e .[test]
  #       pip install testbook
  #       pip install global_land_mask dotenv imageio nrel-pysam
  #   - name: Run notebook with testbook and monkeypatching
  #     env:
  #       api_key: "DEMO_KEY"
  #       email: "user@mail.com"
  #     run: |
  #       python scripts/notebooks_testbook.py "tutorials_and_tools/tutorials_and_tools/${{ matrix.notebook-file }}"
 notebook-testbook-check:
    runs-on: ubuntu-latest
    env:
      NOTEBOOK_DIR: "tutorials_and_tools/tutorials_and_tools"
      TESTBOOK_NOTEBOOK_LIST: |
        "API Call Required - PYSam.ipynb"
        "API Call Required - load_nsrdb_distributed.ipynb"
        "HPC Connection Required - Geospatial_world_map.ipynb"
        "HPC Connection Required - DuraMAT Live Demo.ipynb"
        "HPC Connection Required - Scenario - Geographical Features.ipynb"
        "HPC Connection Required - Scenario - Geospatial.ipynb"
        "HPC Connection Required - Scenario - Non-uniform Mountain Prefferential Downselect.ipynb"
        "HPC Connection Required - Scenario - Single Location.ipynb"
        "HPC Connection Required - Scenario - Temperature.ipynb"
        "HPC Connection Required - Tools - Module Standoff for IEC TS 63126.ipynb"
        "HPC Connection Required - LETID - Outdoor Geospatial Demo.ipynb"
        "HPC Connection Required - Geospatial Templates.ipynb"

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install notebook environment
        run: |
          python -m pip install --upgrade pip wheel
          pip install --timeout=300 -r tutorials_and_tools/requirements.txt
          pip install --timeout=300 -e .[test]
          pip install testbook
          pip install global_land_mask dotenv imageio nrel-pysam
      - name: Run all testbook notebooks in one environment
        env:
          api_key: "DEMO_KEY"
          email: "user@mail.com"
        run: |
          mapfile -t NOTEBOOKS < <(echo "$TESTBOOK_NOTEBOOK_LIST")
          for notebook in "${NOTEBOOKS[@]}"; do
            NOTEBOOK_NAME="${notebook//\"/}"
            FULL_PATH="$NOTEBOOK_DIR/$NOTEBOOK_NAME"
            echo "Testing $FULL_PATH with testbook..."
            python scripts/notebooks_testbook.py "$FULL_PATH"
          done
